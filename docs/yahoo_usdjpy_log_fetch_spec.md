# Yahoo ドル円掲示板ログ取得（簡易仕様）

## 目的
指定した期間（開始日から終了日）について、1日1スレの書き込み（レス）をまとめて取得し、あとで分析やバックテストに使える形で保存する。

## 現状の実装（叩き台）
- 画面付きのWindows用デスクトップアプリ: `app/app.py`
- 期間指定: 開始日・終了日を入力して実行
- 待ち時間: 「20件取得するごとの休止間隔（秒）」を画面で設定（初期値 0.5 秒）
- 追加休止1: 「◯ページごとに◯秒休憩」を画面で設定（初期値 50ページごとに10秒、チェックでオン）
- 追加休止2: 「◯ページごとに◯秒休憩」を画面で設定（初期値 200ページごとに60秒、チェックでオン）
- 進み具合: 画面に表示
- 停止: 停止ボタンで中断
- 保存先: `logs`
- 保存形式: 日ごとに `usdjpy_YYYYMMDD.jsonl`（1行が1件の形式）で保存

起動方法:
- `python app/app.py`

日付の入力（例）:
- `2026-01-16`
- `2026/01/16`
- `20260116`

## 取得先（通信先）
レス一覧の追加読み込みで使われている取得用URLは次の通り。

- `GET https://finance.yahoo.co.jp/cm/ds/comment/listview`

補足:
- この取得は「画面の追加読み込み」扱いにしないと、通常ページへ飛ばされることがある。実装では `X-Requested-With: XMLHttpRequest` を付けている。

## 送る値（主な引数）
※名前はそのまま使う（URLに付ける名前なので変更しない）

- `category=552023129`
- `thread=usdjpy`
- `part={スレ番号}`（例: 3291）
- `thread_stop_flag=1`
- `tieup_name=fx`
- `thread_name={スレのタイトル（URL用に変換した文字列）}`
- `thread_feel_type=`（空のまま）
- `offset={どのレス番号から取るか}`
- `page={ページ番号}`
- `_={同じ結果の使い回しを避けるための値}`（現在時刻などでよい）

## 返ってくる内容（形式）
返り値は「JSON（文字列のまとまり）」で、その中の `feed.content` に「レス一覧のHTML断片」が入っている。

HTML断片から、次の情報を取り出せる。
- 各レス: `<li id="cNNNN">`（`NNNN` がレス番号）
- レス番号: `<span class="comNum">`
- 投稿の内部番号: `.comment` の `data-comment`
- 投稿者の識別子: 投稿者リンクの `data-user`
- 投稿時刻: `.comWriter` 内のリンク文字（例: `1月17日 01:03`）
- 本文: `<p class="comText">`（`<br>` は改行に直す）
- 返信先（ある場合）: `<p class="comReplyTo">` や `data-parent_comment`

## ページの進め方（無限スクロールの再現）
確認できた動き（`part=3291` の例）:
- 1回の取得で約20件が返る
- 下にスクロールして追加表示すると、`page` が増え、`offset` が小さくなる
- `page=1` はエラーになることがあったため、`page=2` から始める

推奨の流れ:
1) 対象スレの通常ページを1回読み、スレ情報から「最新のレス番号」を読む（例: `threadLength` が `5,365` なら最新は 5365）
2) `listview` を `offset=最新レス番号`, `page=2` で呼ぶ
3) 返ってきたHTMLからレスを抜き出し、その中でいちばん小さいレス番号（最古）を控える
4) 次は `page` を +1 し、`offset` を「最古レス番号 - 1」にして呼ぶ
5) `feed.content` にレスが無い（`<li>` が無い）/ 同じレスしか出ない / `offset < 1` になったら終了

## 期間指定（日時とスレ番号の扱い）
### 日付から `part` を決める方法（方法A: 基準日から日数差で計算）
前提:
- `part` は基本的に「1日進むと +1」になる（1日1スレ）
- すでに分かっている「日付と `part` の組」を1つ用意して、それを基準にする

基準（現状の実装で採用）:
- `2026/01/16` のログ = `part=3291`

式（考え方）:
- `目標part = 基準part + (目標日 - 基準日の日数)`

例:
- `2026/01/15` は基準日の1日前 → `3291 - 1 = 3290`
- `2026/01/14` は基準日の2日前 → `3291 - 2 = 3289`
- `2025/12/01` は基準日の46日前 → `3291 - 46 = 3245`

注意:
- もし「毎日きっちり +1」が崩れる日があると、この計算はずれる可能性がある。
- ずれを見つけたい場合は、計算で出した `part` の通常ページ（例: `https://finance.yahoo.co.jp/cm/message/552023129/usdjpy/3291`）を開いて、ページ上のスレ日付表示が想定日と一致するか確認する。

### 日付の割り当て（スレの日付と投稿時刻）
- レスの表示時刻が日付またぎになることがあるため、どの基準で日付に割り当てるか決める必要がある
  - 例: 「スレの1日」にまとめて所属させる（簡単）
  - 例: 投稿時刻の実日付で切り分ける（厳密だが手間）

## 保存（現状）
- 保存先フォルダ: `logs`
- ファイル名: `usdjpy_YYYYMMDD.jsonl`（例: `usdjpy_20260116.jsonl`）
- 1行に1件ずつ保存（中身は `json`）
- 主な項目: `part`, `comment_no`, `posted_at`, `user_id`, `text`, `reply_to`, `comment_id`

将来的にデータが増えて検索や集計が必要になったら、`SQLite` に移す（1つのファイルにまとめる）方が扱いやすい。

## アクセスの配慮（安定動作のため）
- 連続アクセスになりすぎないよう、一定時間待つ（画面で設定できる）
- 追加休止1と追加休止2は任意でオンにできる（オフなら毎ページの待ちだけ）
- 一時的な失敗は、待ち時間を少しずつ増やして再試行する（今後の改善ポイント）
- 失敗したときに `part/page/offset` を記録して、途中から再開できるようにする（今後の改善ポイント）
