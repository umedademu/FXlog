# Yahoo ドル円掲示板ログ取得（簡易仕様）

## 目的
指定したスレ番号の範囲について、書き込み（レス）をまとめて取得し、あとで分析やバックテストに使える形で保存する。

## 現状の実装（叩き台）
- 画面付きのWindows用デスクトップアプリ: `app/app.py`
- 番号指定: 開始番号・終了番号を入力して実行
- 年なしの年: `posted_at` に年が無い場合の補完年を手入力（初期値 2026）
- 待ち時間: 「1ページ取得ごとの休止時間（秒）」を最小〜最大で設定（初期値 0.3〜0.6、範囲内でランダム）
- 追加休止1: 「◯ページごとに◯秒休憩」を最小〜最大で設定（初期値 50ページごとに5〜15秒、チェックでオン/オフ）
- 追加休止2: 「◯ページごとに◯秒休憩」を最小〜最大で設定（初期値 200ページごとに15〜30秒、チェックでオン/オフ）
- 進み具合: 画面に表示（対象番号、ページ進捗、件数など）
- 停止: 停止ボタンで中断
- 保存先: `logs`
- 保存形式: `usdjpy_{part}_YYYYMMDD.jsonl`（1行が1件の形式）で保存
- 入力内容: 自動で保存され、次回起動時に復元

起動方法:
- `python app/app.py`

番号の入力（例）:
- 開始番号 `3291`
- 終了番号 `3289`

## 取得先（通信先）
レス一覧の追加読み込みで使われている取得用URLは次の通り。

- `GET https://finance.yahoo.co.jp/cm/ds/comment/listview`

補足:
- この取得は「画面の追加読み込み」扱いにしないと、通常ページへ飛ばされることがある。実装では `X-Requested-With: XMLHttpRequest` を付けている。

## 送る値（主な引数）
※名前はそのまま使う（URLに付ける名前なので変更しない）

- `category=552023129`
- `thread=usdjpy`
- `part={スレ番号}`（例: 3291）
- `thread_stop_flag=1`
- `tieup_name=fx`
- `thread_name={スレのタイトル（URL用に変換した文字列）}`
- `thread_feel_type=`（空のまま）
- `offset={どのレス番号から取るか}`
- `page={ページ番号}`
- `_={同じ結果の使い回しを避けるための値}`（現在時刻などでよい）

## 返ってくる内容（形式）
返り値は「JSON（文字列のまとまり）」で、その中の `feed.content` に「レス一覧のHTML断片」が入っている。

HTML断片から、次の情報を取り出せる。
- 各レス: `<li id="cNNNN">`（`NNNN` がレス番号）
- レス番号: `<span class="comNum">`
- 投稿の内部番号: `.comment` の `data-comment`
- 投稿者の識別子: 投稿者リンクの `data-user`
- 投稿時刻: `.comWriter` 内のリンク文字（例: `1月17日 01:03`）
- 本文: `<p class="comText">`（`<br>` は改行に直す）
- 返信先（ある場合）: `<p class="comReplyTo">` や `data-parent_comment`

## ページの進め方（無限スクロールの再現）
確認できた動き（`part=3291` の例）:
- 1回の取得で約20件が返る
- 下にスクロールして追加表示すると、`page` が増え、`offset` が小さくなる
- `page=1` はエラーになることがあったため、`page=2` から始める

推奨の流れ:
1) 対象スレの通常ページを1回読み、スレ情報から「最新のレス番号」を読む（例: `threadLength` が `5,365` なら最新は 5365）
2) `listview` を `offset=最新レス番号`, `page=2` で呼ぶ
3) 返ってきたHTMLからレスを抜き出し、その中でいちばん小さいレス番号（最古）を控える
4) 次は `page` を +1 し、`offset` を「最古レス番号 - 1」にして呼ぶ
5) `feed.content` にレスが無い（`<li>` が無い）/ 同じレスしか出ない / `offset < 1` になったら終了

## 番号指定（スレ番号の扱い）
- URL末尾の番号（part）をそのまま範囲指定する
- 開始番号と終了番号はどちら向きでも指定できる（大→小でも可）

### ファイル名の日付の決め方
- そのスレの「一番最初のレス」（comment_no が最小）の `posted_at` を日付として使う
- `posted_at` に年がある場合はその年を使う
- 年が無い場合は、画面の「年なしの年」で補完する

## 保存（現状）
- 保存先フォルダ: `logs`
- ファイル名: `usdjpy_{part}_YYYYMMDD.jsonl`（例: `usdjpy_3193_20260116.jsonl`）
- 1行に1件ずつ保存（中身は `json`）
- 主な項目: `part`, `comment_no`, `posted_at`, `user_id`, `text`, `reply_to`, `comment_id`

将来的にデータが増えて検索や集計が必要になったら、`SQLite` に移す（1つのファイルにまとめる）方が扱いやすい。

## アクセスの配慮（安定動作のため）
- 連続アクセスになりすぎないよう、待ち時間は範囲指定でランダムに待つ（画面で設定できる）
- 追加休止1と追加休止2は任意でオンにできる（オフなら毎ページの待ちだけ）
- 一時的な失敗は、待ち時間を少しずつ増やして再試行する（今後の改善ポイント）
- 失敗したときに `part/page/offset` を記録して、途中から再開できるようにする（今後の改善ポイント）
