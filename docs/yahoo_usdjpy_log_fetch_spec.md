# Yahoo ドル円掲示板ログ取得（簡易仕様）

## 目的
指定した期間（開始日〜終了日）について、1日1スレの書き込み（レス）をまとめて取得し、あとで分析やバックテストに使える形で保存する。  
この資料は「取得の仕組み」だけをまとめる。画面（見た目・操作）は後で詰める。

## 取得先（通信先）
レス一覧を追加で読み込むときに呼ばれている取得用URLは次の通り。

`GET https://finance.yahoo.co.jp/cm/ds/comment/listview`

例（実際に確認できたもの）:
`https://finance.yahoo.co.jp/cm/ds/comment/listview?category=552023129&thread=usdjpy&part=3291&thread_feel_type=&thread_stop_flag=1&tieup_name=fx&thread_name=%E3%82%A2%E3%83%A1%E3%83%AA%E3%82%AB%20%E3%83%89%E3%83%AB%20%2F%20%E6%97%A5%E6%9C%AC%20%E5%86%86%E3%80%90usdjpy%E3%80%91&offset=5121&page=12&_=1768665397663`

## 送る値（主な引数）
※名前はそのまま使う（URLに付ける名前なので変更しない）

- `category=552023129`
- `thread=usdjpy`
- `part={スレ番号}`（例: 3291）
- `thread_stop_flag=1`
- `tieup_name=fx`
- `thread_name={スレのタイトル（URL用に変換した文字列）}`
- `thread_feel_type=`（空のまま）
- `offset={どのレス番号から取るか}`
- `page={ページ番号}`
- `_={同じ結果の使い回しを避けるための値}`（現在時刻などでよい）

補足:
- `thread_name` は、いちどスレのページからコピーして固定で使い回せる可能性が高い。
- `_` は現在時刻（ミリ秒）などで問題ないことが多い。

## 返ってくる内容（形式）
返り値は「JSON（文字列のまとまり）」で、その中の `feed.content` に「レス一覧のHTML断片」が入っている。

HTML断片から、次の情報を取り出せる。
- 各レス: `<li id="cNNNN">`（`NNNN` がレス番号）
- レス番号: `<span class="comNum">`
- 投稿の内部番号: `.comment` の `data-comment`
- 投稿者の識別子: 投稿者リンクの `data-user`
- 投稿時刻: `.comWriter` 内のリンク文字（例: `1月17日 01:03`）
- 本文: `<p class="comText">`（`<br>` は改行に直す）
- 返信先（ある場合）: `<p class="comReplyTo">` や `data-parent_comment`

## ページの進め方（無限スクロールの再現）
確認できた動き:
- 1回の取得でおおむね約100件が返る
- 下にスクロールして追加表示すると、`page` が増え、`offset` が小さくなる

推奨の流れ:
1) まず対象スレの通常ページを1回読み、表示されている先頭のレスから「最新のレス番号」を読む（例: `id="c5121"` なら最新は 5121）
2) `listview` を `offset=最新レス番号`, `page=1` で呼ぶ
3) 返ってきたHTMLからレスを抜き出し、その中でいちばん小さいレス番号（最古）を控える
4) 次は `page` を +1 し、`offset` を「最古レス番号 - 1」にして呼ぶ
5) `feed.content` にレスが無い（`<li>` が無い）/ 同じレスしか出ない / `offset < 1` になったら終了

## 期間指定（日時とスレ番号の扱い）
### 日付から `part` を決める方法（方法A: 基準日から日数差で計算）
この方法で「2025/12/01 のログを取りたいとき、末尾（`part`）をいくつにするか」を決められるようにする。

前提:
- `part` は基本的に「1日進むと +1」になる（1日1スレ）
- すでに分かっている「日付と `part` の組」を1つ用意して、それを基準にする

基準（今回の前提）:
- `2026/01/16` のログ = `part=3291`

計算ルール:
- 目標日が基準日より未来なら `part` は増える
- 目標日が基準日より過去なら `part` は減る

式（考え方）:
- `目標part = 基準part + (目標日 - 基準日の日数)`

例:
- `2026/01/15` は基準日の1日前 → `3291 - 1 = 3290`
- `2026/01/14` は基準日の2日前 → `3291 - 2 = 3289`
- `2025/12/01` は基準日の46日前 → `3291 - 46 = 3245`

注意:
- もし「毎日きっちり +1」が崩れる日があると、この計算はずれる。
- ずれを見つけるために、計算で出した `part` の通常ページ（例: `https://finance.yahoo.co.jp/cm/message/552023129/usdjpy/3291`）を開いて、ページ内の「このスレの日付表示」が想定日と一致するか確認する手順を入れるのが安全。

### 日付の割り当て（スレの日付と投稿時刻）
- レスの表示時刻が日付またぎになることがあるため、どの基準で日付に割り当てるか決める必要がある
  - 例: 「スレの1日」にまとめて所属させる（簡単）
  - 例: 投稿時刻の実日付で切り分ける（厳密だが手間）

## 保存（おすすめ）
Python中心なら、まずは `SQLite`（1つのファイルに保存できる形式）がおすすめ。あとで集計や条件検索がしやすく、重複も防ぎやすい。

最低限の保存項目（案）:
- `comments`（レス）
  - `part`（スレ番号）
  - `comment_no`（レス番号）
  - `posted_at`（投稿時刻の文字列、または整形後の日時）
  - `user_id`
  - `text_raw`（HTMLのまま）
  - `text_clean`（改行などを整形した本文）
  - `reply_to`（返信先があるとき）
  - `comment_id`（data-comment）
- `threads`（スレ）
  - `part`
  - `thread_date`（スレの対象日）
- `raw_responses`（任意。復元用）
  - `part`, `page`, `offset`, `fetched_at`, `content_html`

重複防止:
- `part + comment_no` を「同じものは2回入れない」ルールにする（ユニーク制約）

## アクセスの配慮（安定動作のため）
- 連続アクセスになりすぎないよう、1〜2秒程度待つ
- 一時的な失敗は、待ち時間を少しずつ増やして再試行する
- 失敗したときに `part/page/offset` を記録して、途中から再開できるようにする

## Windows用デスクトップアプリ（前提）
- 期間（開始日・終了日）を指定して実行できる
- 日ごとに `part` を決めて全件取得し、`SQLite` に保存する
- 進み具合の表示と、途中再開ができることを目標にする
